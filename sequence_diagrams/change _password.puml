@startuml

title Sequence diagram for Change Password

actor User
boundary ChangePasswordForm
control AuthMiddleware
control UserController
participant UserService
participant Database as "UserDB"

== Change Password Process ==
User -> ChangePasswordForm: (1) Enter old and new password
activate ChangePasswordForm
ChangePasswordForm -> AuthMiddleware: (2) Attach authorization token
activate AuthMiddleware
AuthMiddleware -> AuthMiddleware: (3) Validate token
alt Invalid Token
    AuthMiddleware --> ChangePasswordForm: (4) Return error "Unauthorized"
    deactivate AuthMiddleware
    ChangePasswordForm --> User: (5) Display error message
    deactivate ChangePasswordForm
else Valid Token
    AuthMiddleware -> UserController: (4) Forward request with user data
    deactivate AuthMiddleware
end

UserController -> UserService: (5) Process change password request
activate UserService
UserService -> UserService: (6) Validate old and new password
alt Invalid Password
    UserService --> UserController: (7) Return error "Invalid password"
    deactivate UserService
    UserController --> ChangePasswordForm: (8) Show error message
    deactivate UserController
    ChangePasswordForm --> User: (9) Display error message
    deactivate ChangePasswordForm
else Valid Password
    UserService -> Database: (7) Retrieve user data by userId
    activate Database
    Database --> UserService: (8) Return user data
    deactivate Database

    alt User not found
        UserService --> UserController: (9) Return error "User not found"
        deactivate UserService
        UserController --> ChangePasswordForm: (10) Show error message
        deactivate UserController
        ChangePasswordForm --> User: (11) Display error message
        deactivate ChangePasswordForm
    else User found
        UserService -> UserService: (9) Compare old password with stored password
        UserService -> UserService: (10) Hash new password
        UserService -> Database: (11) Update user password
        activate Database
        Database --> UserService: (12) Confirm password updated
        deactivate Database
        UserService --> UserController: (13) Return success "Password changed successfully"
        deactivate UserService
        UserController --> ChangePasswordForm: (14) Notify user of success
        deactivate UserController
        ChangePasswordForm --> User: (15) Display success message
        deactivate ChangePasswordForm
    end
end

@enduml